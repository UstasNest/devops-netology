# Домашнее задание к занятию "6.6. Troubleshooting"

## Задача 1

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести данную операцию:
- напишите список операций, которые вы будете производить для остановки запроса пользователя   
найдем opid для соответствующей базы (db1):   
```
db.currentOp(
   {
     "active" : true,
     "secs_running" : { "$gt" : 180 },
     "ns" : /^db1\./
   }
)
```
если идет чтение то убиавем  операцию:  
````
db.killOp(<opid>)
````
если идет операция записи вначале надо убить сессии пользователя, затем db.killOp(<opid>) :    
````
use config
db.system.sessions.aggregate( [ { $listSessions: { users: [ {user: "myAppReader", db: "bd1" } ] } } ] )
db.runCommand(
   {
     killSessions: [ { id : <UUID> }, ... ]
   }
)

````

- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB:   
настроить мониторинг и алертинг на долгие транзакции, настроить триггеры на удаление подобных операций,   
по подобным случаям эскалировать проблему к пользователям/разработчикам    


## Задача 2

Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причем отношение количества записанных key-value значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:
- сначала рост отношения записанных значений к истекшим
- Redis блокирует операции записи

Как вы думаете, в чем может быть проблема?  

Если в базе есть много ключей срок действия которых истекает в одну и ту же секунду и они составляют не менее 25% от совокупного колиечства ключей с установленным сроком действия, Реддис заблокирует операции записи чтобы процент снизился менее 25%.  
Цикл очистки ключей запускается 10 раз в 1 сек, ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP по умолчанияю равен 20, в итоге удаляется за  1 сек 200 истекших ключей, но если процент не становится ниже 25%, то цикл повторяется.
 
## Задача 3

Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей, в таблицах базы,
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?  
учитывая что что появились проблемы по мере роста количества записей, соединения отваливаются из за сетевого соединения или таймаутов которые начинают расти при запросах в БД больших объемов данных, либо нужно оптимизировать таблицы или запросы  
Какие пути решения данной проблемы вы можете предложить?
1. Проверить сетевое соединение, посмотреть когда происходит разрыв соединения, настроить пременные связынные с таймаутами
2. посмотреть переменную Aborted_clients, Которая увеличивается при каждом не нормальном разрыве соединения клиентом, можно увеличить wait_timeout и interactive_timeout   
3. Проверить и увеличить переменную connect_timeout
4. При получении данных от клиента может помочь тюнинг параметра net_read_timeout
5. возможно, если идут большие пакеты можно увеличить max_allowed_packet  
## Задача 4


Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объемом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?  
у сервера или процесса заканчивается память, и чтобы спасти систему от критического сбоя, oom-killer жертвует процессом.

Как бы вы решили данную проблему?
1. надо включить мониторинг, и понаблюдать за процессом выделения и потребления памяти   
2. возможно слишком много ресурсов потребляют какие то процессы или запросы СУБД
3. настройках postgresql ограничить память выделяемую для сервера БД  
4. проверить может на сервере есть еще приложения которые потребляют память, перенести их оттуда  
5. по результатам мониторинга возможно нужно нарастить физический объем памяти, места и т.д.  
---

### Как cдавать задание

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---